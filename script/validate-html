#!/usr/bin/env ruby
# frozen_string_literal: true

require "w3c_validators"

def validator(file)
  extension = File.extname(file)
  if extension == ".html"
    W3CValidators::NuValidator.new
  elsif extension == ".css"
    W3CValidators::CSSValidator.new
  end
end

def validate(file)
  puts "Checking #{file}..."

  path = File.expand_path "../_site/#{file}", __dir__
  results = validator(file).validate_file(path)

  # Filter out known false positives
  # pointer-events is valid CSS3 but some validators don't recognize it
  filtered_errors = results.errors.reject do |err|
    err_str = err.to_s.downcase
    err_str.include?("pointer-events") && (
      err_str.include?("doesn't exist") ||
      err_str.include?("does not exist") ||
      err_str.include?("unknown property")
    )
  end

  return puts "Valid!" if filtered_errors.empty?

  filtered_errors.each { |err| puts err }
  exit 1
end

validate "index.html"
validate File.join "assets", "css", "style.css"
